




20200824 (월) 
### 수업 목차
#### 1. DataStorage 매커니즘 3 | Databases
[예제1) Room을 이용한 Data 저장 (JPA와 유사) (완료) ](#예제1--Room을-이용한-Data-저장)  <br/>



<br/>
<br/>


##  1. DataStorage 매커니즘 3 | Databases

### 예제1) Room을 이용한 Data 저장

[(참고) 안드로이드 developers | Room 사용 가이드](https://developer.android.com/training/data-storage/room)

> 순서 

1.  build.gradle (Module:app) 파일 셋팅
```java
dependencies {  
  def room_version = "2.2.5"  
  
  implementation "androidx.room:room-runtime:$room_version"  
  annotationProcessor "androidx.room:room-compiler:$room_version" // For Kotlin use kapt instead of annotationProcessor  
  
 // optional - Kotlin Extensions and Coroutines support for Room  implementation "androidx.room:room-ktx:$room_version"  
  
  // optional - RxJava support for Room  
  implementation "androidx.room:room-rxjava2:$room_version"  
  
  // optional - Guava support for Room, including Optional and ListenableFuture  
  implementation "androidx.room:room-guava:$room_version"  
  
  // Test helpers  
  testImplementation "androidx.room:room-testing:$room_version"  
  
}
```
2. Member VO (테이블) 생성 (autoGenerate 추가)
```java
package com.example.storagetest;


import androidx.room.Entity;
import androidx.room.PrimaryKey;

//VO 클래스(테이블)
@Entity
public class Member {
    @PrimaryKey(autoGenerate = true) //시퀀스 자동할당
    public int _id;
    public String name;
    public String tel;

    public Member() {
    }

    public Member(int _id, String name, String tel) {
        this._id = _id;
        this.name = name;
        this.tel = tel;
    }

    @Override
    public String toString() {
        return "_id=" + _id + "     name= " + name + "      tel=" + tel;
    }
}


```

3. MemberDao interface (JPARepository 역할)
```java
package com.example.storagetest;  
  
import androidx.room.Dao;  
import androidx.room.Delete;  
import androidx.room.Insert;  
import androidx.room.Query;  
import androidx.room.Update;  
  
import java.util.List;  
  
//JPARepository 역할  
@Dao  
public interface MemberDao {  
   @Insert  
   void insert(Member m);  
  
  @Query("select * from member")  
   List<Member> selectAll();  
  
  @Query("select * from member where _id=(:id)")//_id 처럼 언더바 쓰면 오류남  
  Member selectById(int id);  
  
  @Delete  
  void delete(Member m);  
  
  @Update  
  void update(Member m);  
}
```

4. AppDatabase (수정)
allowMainThreadQueries로 UI 쓰레드(메인쓰레드)에서 DB작업 허용시키기
```java
package com.example.storagetest;  
  
import android.content.Context;  
  
import androidx.room.Database;  
import androidx.room.Room;  
import androidx.room.RoomDatabase;  
  
@Database(entities = {Member.class}, version=1)  
  // 테이블 추가하려면 entities에 추가
  public abstract class AppDatabase extends RoomDatabase {  
  private static AppDatabase appDatabase;//database  
  public abstract MemberDao memberDao();//Repository 객체
  //public abstract MemberDao blahblahDao();//Repository 객체 추가
  public static AppDatabase getInstance(Context context){  
 
 /*  
 db에는 커넥션 생성 시간이 젤 오래 걸림  
 따라서 매번 불필요하게 생성하지 않고 싱글톤으로 하나만 만들어서 클래스 내에서 공유한다.  
 */  
 
  if(appDatabase==null){  
    appDatabase = Room.databaseBuilder(context, AppDatabase.class, "app_db")  
    .allowMainThreadQueries()//원래 room db 작업은 ui thread에서 실행할 수 없으나, 이를 허용하는 코드  
    .build();  
}  
    return appDatabase; 
  }  
  
    public static void delDB(){  
        appDatabase = null;  
  }  
}
```

5. RoomActivity 
- activity_room.xml
![image](https://user-images.githubusercontent.com/62331803/90844674-6ad6f900-e39f-11ea-95cc-abcbd92ff7b1.png)

- RoomActivity.java <br/>

<details>
<summary>RoomActivity.java 전체코드보기 (완료) </summary>

```java
package com.example.storagetest;

import androidx.appcompat.app.AppCompatActivity;

import android.os.AsyncTask;
import android.os.Bundle;
import android.view.View;
import android.widget.ArrayAdapter;
import android.widget.EditText;
import android.widget.ListView;

import java.util.ArrayList;

public class RoomActivity extends AppCompatActivity {
    private AppDatabase database;
    private MemberDao dao;
    private ArrayList<Member> list;
    private ArrayAdapter<Member> adapter;
    private EditText name_et;
    private EditText tel_et;
    private ListView listView;

    @Override
    protected void onCreate(Bundle savedInstanceState) {
        super.onCreate(savedInstanceState);
        setContentView(R.layout.activity_room);
        name_et = findViewById(R.id.name_et);
        tel_et = findViewById(R.id.tel_et);
        listView = findViewById(R.id.lv2);

        database = AppDatabase.getInstance(getApplicationContext());
        dao = database.memberDao();

        list = new ArrayList<>();
        adapter = new ArrayAdapter<>(this, android.R.layout.simple_list_item_1, list);
        listView.setAdapter(adapter);
		
		getAll();
    }

    //room은 기본적으로 ui쓰레드(메인쓰레드)에서 db작업하는 것을 허용하지 않음.
    //따라서 AppDatabase에서 allowmainthreadquery를 설정해줌으로써 억지로 db작업을 가능케 함.
    public void getAll(){
        list.clear();
        ArrayList<Member> tmp = (ArrayList<Member>) dao.selectAll();//allowmainthreadquery로 허용
        if(tmp==null){
            return;
        }
        list.addAll(tmp);
        System.out.println(list);
        adapter.notifyDataSetChanged();
    }
    public void onSave(View view){
        String n = name_et.getText().toString();
        String t = tel_et.getText().toString();
        dao.insert(new Member(0,n,t));//allowmainthreadquery로 허용
        getAll();
    }
}
```

</details>

<br/>

> 오류 해결 

databases의 app_db관련 파일3개 삭제하고 다시 run <br/>
![image](https://user-images.githubusercontent.com/62331803/90993036-373dde00-e5ee-11ea-9b42-70e0515f82f9.png)

>결과화면

![image](https://user-images.githubusercontent.com/62331803/90993296-48d3b580-e5ef-11ea-952f-e52630f2fc53.png)

<br/>

### 예제2) 메시지큐와 핸들러를 이용한 Data 저장 (RoomDBTest 프로젝트)

1. Member.java (예제1과 동일)
```java
package com.example.roomdbtest;


import androidx.room.Entity;
import androidx.room.PrimaryKey;

//VO 클래스(테이블)
@Entity
public class Member {
    @PrimaryKey(autoGenerate = true)
    public int _id;
    public String name;
    public String tel;

    public Member() {}

    public Member(int _id, String name, String tel) {
        this._id = _id;
        this.name = name;
        this.tel = tel;
    }

    @Override
    public String toString() {
        return "_id=" + _id + "     name= " + name + "      tel=" + tel;
    }
}
```

<br/>

2. MemberDao.java 인터페이스 (예제1과 동일)
```java
package com.example.roomdbtest;

import androidx.room.Dao;
import androidx.room.Delete;
import androidx.room.Insert;
import androidx.room.Query;
import androidx.room.Update;

import java.util.List;

//JPARepository 역할
@Dao
public interface MemberDao {
    @Insert
    void insert(Member m);

    @Query("select * from member")
    List < Member > selectAll();

    @Query("select * from member where _id=(:id)") //_id 처럼 언더바 쓰면 오류남
    Member selectById(int id);

    @Delete
    void delete(Member m);

    @Update
    void update(Member m);
}
```
<br/>

3.  AppDatabase.java  (예제1과 동일)
```java
package com.example.roomdbtest;

import android.content.Context;

import androidx.room.Database;
import androidx.room.Room;
import androidx.room.RoomDatabase;

@Database(entities = {
    Member.class
}, version = 1)
public abstract class AppDatabase extends RoomDatabase {
    private static AppDatabase appDatabase; //database
    public abstract MemberDao memberDao(); //Repository 객체

    public static AppDatabase getInstance(Context context) {
        //싱글톤으로 생성

        if (appDatabase == null) {
            appDatabase = Room.databaseBuilder(context, AppDatabase.class, "app_db").build();
        }
        return appDatabase;
    }

    public static void delDB() {
        appDatabase = null;
    }
}
```
<br/> 
4. MemberDBAdapter.java

 <details>
<summary> 코드보기 </summary>

 ```java
package com.example.roomdbtest;

import android.content.Context;
import android.os.Handler;
import android.os.Message;

import java.util.ArrayList;
import java.util.concurrent.ExecutorService;
import java.util.concurrent.Executors;

public class MemberDBAdapter {
    private AppDatabase database;
    private MemberDao dao;
    private ExecutorService executorService; //db 백그라운드 작업을 위한 도구(쓰레드)
    private Handler handler; //UI thread와 db작업 thread 사이에 메시지 교환을 돕는 역할.

    public MemberDBAdapter(Context context, Handler handler) {
        this.handler = handler; //한쪽에서 만들어서 두 측에서 함께 쓴다.
        database = AppDatabase.getInstance(context);
        dao = database.memberDao();
        executorService = Executors.newSingleThreadExecutor();
    }

    //1. 전체 검색
    public void getAll() {
        executorService.execute(new Runnable() {
            @Override
            public void run() {
                Message msg = handler.obtainMessage(); //메세지를 담을 객체 생성
                msg.what = 0; //메세지 종류 설정.(반대편에 반환할 값을 알려주는 역할. list<Member> or Member...)
                //msg.arg1 : 메세지 값이 int 타입인 경우
                //msg.obj : 메세지 값이 클래스 타입인 경우
                msg.obj = (ArrayList < Member > ) dao.selectAll();
                handler.sendMessage(msg); //handler를 통해 main activity에 전달.
            }
        });
    }

    //2. 멤버 1명 검색
    public void getMember(final int _id) {
        executorService.execute(new Runnable() {
            @Override
            public void run() {
                Message msg = handler.obtainMessage();
                msg.what = 1;
                msg.obj = dao.selectById(_id);
                handler.sendMessage(msg);
            }
        });
    }

    public void addMember(final Member m) {
        executorService.execute(new Runnable() {
            @Override
            public void run() {
                dao.insert(m);
            }
        });
    }


    public void editMember(final Member m) {
        executorService.execute(new Runnable() {
            @Override
            public void run() {
                dao.update(m);
            }
        });
    }

    public void delMember(final Member m) {
        executorService.execute(new Runnable() {
            @Override
            public void run() {
                dao.delete(m);
            }
        });
    }
}
 ```

 </details>
 
 <br/> 
 
 5. Main
> activity_main.xml <br/>

![image](https://user-images.githubusercontent.com/62331803/90995120-f2b64080-e5f5-11ea-9d7a-49018b3ae5b8.png)


> MainActivity.java
<details>
<summary> 코드보기 </summary>

```java
package com.example.roomdbtest;

import androidx.annotation.NonNull;
import androidx.appcompat.app.AppCompatActivity;

import android.os.Bundle;
import android.os.Handler;
import android.os.Looper;
import android.os.Message;
import android.view.View;
import android.widget.ArrayAdapter;
import android.widget.EditText;
import android.widget.ListView;

import java.util.ArrayList;

public class MainActivity extends AppCompatActivity {
    private EditText name_et;
    private EditText tel_et;
    private ListView listView;
    private ArrayAdapter < Member > adapter;
    private ArrayList < Member > list;
    private Handler handler;
    private MemberDBAdapter db;

    @Override
    protected void onCreate(Bundle savedInstanceState) {
        super.onCreate(savedInstanceState);
        setContentView(R.layout.activity_main);
        name_et = findViewById(R.id.name_et);
        tel_et = findViewById(R.id.tel_et);
        listView = findViewById(R.id.lv1);
        list = new ArrayList < > ();

        adapter = new ArrayAdapter < > (this, android.R.layout.simple_list_item_1, list);
        listView.setAdapter(adapter);

        //handler == msg queue(쓰레드 간에 통신을 할 수 있게)
        handler = new Handler(Looper.getMainLooper()) { //looper: 내부 loop (내부에 메세지가 존재하면 계속 반복)
            //메세지가 도착하면 자동으로 호출됨
            @Override
            public void handleMessage(@NonNull Message msg) {
                if (msg.what == 0) { //전체 검색
                    ArrayList < Member > tmp = (ArrayList < Member > ) msg.obj;
                    list.clear();
                    list.addAll(tmp);
                    adapter.notifyDataSetChanged();
                } else { //msg.what==1: 멤버 1명 검색
                    Member x = (Member) msg.obj;
                    name_et.setText(x.name);
                    tel_et.setText(x.tel);
                }
            }
        };
        db = new MemberDBAdapter(this, handler);
    }


    public void onSave(View view) {
        String n = name_et.getText().toString();
        String t = tel_et.getText().toString();
        db.addMember(new Member(0, n, t));
        name_et.setText("");
        tel_et.setText("");
        db.getAll();
    }
    public void onEdit(View view) {

    }

    //화면 시작되자마자 실행되는 코드
    @Override
    protected void onPostResume() {
        super.onPostResume();
        db.getAll(); //onCreate에 넣으면 싱크 안맞음
    }
}
```


</details>


> 결과화면 <br/>

![image](https://user-images.githubusercontent.com/62331803/90995876-38740880-e5f8-11ea-8973-14ad3cf834de.png)



## 2.  큰 제목

### 부제

> 파일명
